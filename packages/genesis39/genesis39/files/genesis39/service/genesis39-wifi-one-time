#!/bin/sh
# Copyright (C) 2020 Gregory L. Dietsche
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 2 as published by the
# Free Software Foundation. This program is distributed in the hope that it
# will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty
# of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# You should have received a copy of the GNU General Public License along with
# this program. If not, see http://www.gnu.org/licenses/.
. /lib/genesis39-functions.sh
. /lib/functions.sh

lan=`uci get network.lan.ifname`
mac=`cat /sys/class/net/$lan/address | sed s/://g | grep -o '....$'`
config_load wireless

wifi_main_ssid() {
  uci -q batch <<-EOT
  set wireless.$1.ssid='Genesis39_$2'
  set wireless.$1.key='Genesis39'
  set wireless.$iface.encryption='psk2'
EOT

}
config_foreach wifi_main_ssid wifi-iface $mac


wifi_addGuest() {
  local iface=$(uci add wireless wifi-iface)
  uci -q batch <<-EOT
    set wireless.$iface.device='$1'
    set wireless.$iface.mode='ap'
    set wireless.$iface.ssid='Genesis39_Guest_$mac'
    set wireless.$iface.key='Genesis39'
    set wireless.$iface.encryption='psk2'
    set wireless.$iface.network='Guest'
    set wireless.$iface.isolate='1'
EOT
}
config_foreach wifi_addGuest wifi-device


wifi_enable() {
  uci -q batch <<-EOT
  delete wireless.$1.disabled
EOT
}
config_foreach wifi_enable wifi-device


uci commit wireless
/sbin/wifi reload

exit 0
